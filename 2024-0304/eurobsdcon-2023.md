# EuroBSDCon 2023

由 Olivier Certner

去年九月，我很荣幸地前往葡萄牙的科英布拉市，那里举办了年度欧洲 BSD 系统技术会议 EuroBSDCon。

尽管我曾几次去过葡萄牙，分别在波尔图附近的杜罗河谷、波尔图市本身或里斯本，但我从未有机会了解科英布拉。这座城市曾是葡萄牙王国的古都，将近一千年前，如今，它是一个重要的文化中心和一个以其大学闻名的充满活力的城市，这所大学是世界上最古老的之一。其地区是葡萄牙第三大人口聚集地，该市的人均收入居全国前列。科英布拉的山坡地带，称为“Baixa”的市中心，由壮丽的古建筑组成，尤其是大学的历史建筑。会议场地距离这里仅几分钟路程，即使是安排紧张的与会者也可以一窥这座迷人的中世纪城市的建筑和氛围。

与许多开发者当面交流的机会非常令人激动，我很幸运在这方面得到了很好的服务。我参加的讲座和演示非常精彩。以下根据我的个人笔记提供了摘要，希望能激起您对这些主题的好奇心。您也可以在会议网站 https://2023.eurobsdcon.org/slides/上找到大部分演讲的幻灯片，以及在 EuroBSDCon YouTube 频道上找到视频记录。

## FreeBSD 的开发者峰会

感谢 FreeBSD 基金会的 Joseph Mingrone，在成为新签约的普通开发者后，我被邀请参加了周四和周五的开发者峰会。在开场会议上，大约有 30 人介绍了自己及其与项目的关系。我已经以姓名认识其中近一半的人，并在视频或电话会议中见过其中一些人，但从未见过其中任何一位。令人惊讶的是，我不记得在巴黎举行的 EuroBSDCon 2017 上见过或认识他们中的任何人，那是我至今唯一参加过的 BSD 会议。说起来，让我向 Jean-Sébastien Pédron 表示迟到的但衷心的感谢，因为他抽出时间在之前的会议上介绍我认识各种人。

来自 FreeBSD 基金会的大批人员参加了会议，还有来自 Netflix 和 Beckhoff 的代表团，以及一些自由职业开发者、教职人员和其他白天不从事 FreeBSD 工作，却在社区中非常活跃的专业人士，比如 Guido van Rooij，他是老牌人士之一，也是 EuroBSDCon 基金会的成员，我想感谢他热情的欢迎。

第一次会议是 FreeBSD 基金会及其各项正在进行的项目的报告，例如改进安装程序（Pierre Pronchéry），WiFi 支持（Bjoern Zeeb，En-Wei Wu），RISC V 支持（Mitchell Horne），bhyve（John Baldwin，Mark Johnston），解决紧迫的安全问题（John Baldwin），用 SIMD 重新实现 libc 的字符串函数（Robert Clausecker），实现 SU+J 快照（Kirk McKusick），改进 CI 和修复ports（Moin Rahman），将 FreeBSD 打造成一个 Cloud Init 平台（Mina Galić），在基础中导入 OpenSSL 3（Pierre Pronchéry），修复 rtprio(2) 并合理化调度优先级，既针对应用程序又针对内部（由作者亲自完成；截至写作本文时仍在进行中）。说实话，我无法跟踪所有的项目，所以请原谅我可能漏掉的任何内容，并建议感兴趣的读者浏览基金会的博客（ https://freebsdfoundation.org/blog）和开发者峰会的维基页面（https://wiki.freebsd.org/DevSummit/202309）以获取更多信息。

随后是由 Justin Gibbs 主讲的主题演讲，他在想象未来 30 年（因为您必须知道，FreeBSD 在去年已经 30 岁了）。通过回顾他自己参与该项目的技术方面和建立基金会的经历，他的主要信息是要培养“为成功而尝试”的态度，并问每个人：“如果你不害怕，你会做什么？”这引发了与会者之间的交流，许多想法被提出，包括：

* 成为智能手机、物联网、任何移动计算的操作系统。
* 成为运行 AI 工作负载的最佳操作系统。
* 成为一个可以互相帮助成长（指导、教学）的大团体。
* 让 20 岁以下预算有限的人在廉价硬件上安装 FreeBSD。
* 一个点按并点击 jail 部署系统，用来取代 Docker 使用。
* 传播上游文化，说服涉及的企业这对他们最有利，让他们允许他们经验丰富的开发人员更多地参与社区。
* CI，自动回归测试。总的来说，要有更多的测试。

这个合成列表是我自己的，所以如果我遗漏或误解了一些要点，我表示歉意。

Sergio Carlavilla Delgado 随后展示了他正在进行的一个新项目的网站，并鼓励人们提供反馈。大约一个月后，一个更成熟的首页通过邮件列表分发，看到所取得的进展及其与我们现有网站之间的差距令人兴奋。

格雷格·华莱士（Foundation’s Director of Partnerships & Research）组织了一次 SWOT（优势、劣势、机会、威胁）会议，再次交换了许多想法。在这里列出所有内容将会太长，格雷格已经制作了一份包含所有输出的文档。可以在 https://wiki.freebsd.org/DevSummit/202309 阅读（滚动查找“community SWOT”一栏，引用了 PDF 附件）。

随后，我们受到乔丹·哈伯德（Jordan Hubbard）的惊喜讲话欢迎，如果我记得正确的话，他“偶然地”在科英巴附近度过了几天（我们真的应该相信吗？）。我记得这是一个关于项目历史的精彩描述，同时也是一个关注他所在 NVIDIA 公司视角下目前重要事项的专题讲座，以及他认为 FreeBSD 应该采纳的智慧。我只有一些笔记，可能不能完全表达它的价值，但大致内容如下。如今，人工智能是“市场”，就像以前的网络和移动设备一样。任何重要的 AI 应用都不能仅仅在单个 GPU 或节点上运行。因此，通信速度至关重要。内核必须支持 CPU 与 GPU，或 CPU 与 DPU 之间的直接通信。UCX（参见 openucx.org）是 Infiniband verbs 的后继者。此外，AI 推断将在边缘进行。

我开始第一个晚上与 Ruslan Bukin 聊天，首先讨论他在 FreeBSD 上的初步 RISC-V port，然后转向各种非技术主题，例如特殊的、主要是低脂的饮食，或者是法国工程在自行车零件方面的高质量。在这个过程中，我发现自己被邀请参加了一个 Netflix 晚宴，与 Jonathan Looney、Warner Losh、Gleb Smirnoff、John Baldwin（当然还有 Ruslan）一起，我大部分时间都在倾听他们的对话，同时享用美味的海鲜。我不知道 Ruslan 是如何做到的，但非常感谢他拉着我参加。

第二天以 Bojan Novkovic 的演讲开始，介绍了一个名为“kbench”的实验性内核基准测试框架。它旨在通过标准化几种用例的流程，帮助检查可重现性并捕获性能退化来促进内核测试。它还可以成为研究项目的良好工具。它的 Python 脚本从一个特定的、预先组装的集合中获取、构建和运行基准测试。Bojan 的短期目标是扩展基准测试池，并为更多指标添加跟踪（ dtrace(1) ， libxo(3) 的实用程序， pmc(3) ）。一个长期的步骤是简化收集数据的后处理。该框架可以在 https://github.com/bnovkov/kbench 找到。

与之前的演讲有松散联系的是 Ruslan Bukin 提出的硬件跟踪框架（ hwt(9) ）。它依赖于内置于 CPU 中的专用硬件支持，即 Intel 的 Processor Trace（PT），以及 ARM 的 CoreSight 和 Statistical Profiling Extensions（SPE）技术。该框架的内核端占据了 3,5k 行，具有调度器和 mmap() 钩子，基于 ioctl 的跟踪上下文管理，用于支持 /dev/hwt 设备和多个后端代码。 hwt(1) 可用于选择操作模式，配置地址范围过滤，并执行进程管理和符号查找。CoreSight 是 ARM 的最古老技术，每个 CPU 只提供一个流。支持它的后端可以在树中的 sys/arm64/coresight 下找到，并且完全功能正常。一些支持 Intel PT 的代码片段也可用。ARM Ltd. 目前正在开发 SPE 后端。

将主题更改为ports和软件包，Michael Reim 介绍了“Ravenports”，这是由 John Marino 于 2017 年开始的新ports系统的最新版本。 Michael 正在使用它，因为他为一家德国的小型托管公司工作，该公司最初在 FreeBSD 上启动，但今天主要是 Linux。其核心功能是具有高并发构建系统和高度自动化（对于小型维护团队而言必不可少），支持子软件包和变体（似乎对应于 FreeBSD 的flavor），支持多平台（所有 BSD，Linux，Solaris 目前暂停，macOS 已被放弃），自包含（包括工具链，基于 GCC，目前为 13.2），具有二进制引导程序，并具有非常更新的软件版本。与 FreeBSD 的ports相比，一些缺点是目前无法移植到小众或过时的 ISA（我怀疑这与不能使用基于 GNAT 的 Ada 编译器有关），仅进行轻度测试，并且拥有更低的port计数。

当晚，当我联系 Joe 询问他的计划时，他邀请我参加了核心团队和基金会会议的跟进晚宴，在那里我可以与基金会的 Deb Goodkin，Greg Wallace，Li Wen-Hsu 和 Ed Maste 以及核心团队的 Mateusz Piotrowski 交谈，所有这些人都非常友好和热情。

## 会议

Henning Brauer，EuroBSDCon 基金会的首席技术官（简称：首席搅局官）以幽默，善良和实用信息开幕了会议，介绍了如何获取饮料以及如何找到不同的房间和感兴趣的区域。他介绍了 Paula Alexandra Silva 的主题演讲：“促进变革：在计算机科学中拥抱性别多样性”。

作为第一次技术讨论，我参加了约翰·鲍德温（John Baldwin）关于 FreeBSD 项目中 NVMe over Fabrics（NVMe-oF）的讲座。这项技术的目标是允许使用 NVMe 接口（更大的并行性，更低的延迟），与那些未直接连接到请求计算机的设备进行通信，而是通过 TCP、RDMA 或光纤通道访问。因为某些我不记得的原因，不幸地错过了概要。试着理解我的笔记，我总结了以下简短的摘要，或许需要谨慎对待。FreeBSD 的实现是一个三层设计，在中间是处理胶囊（数据缓冲区）的传输抽象。由于这样，你可以仅分配一个队列对，并且不必处理传输的具体细节。用户空间库 libnvmf ，旨在简化和便于调试（不是线程安全，在套接字上阻塞 I/O）。它提供了一个 TCP 实现。还有部分功能的用户空间实现，既可以作为主机（ nvmfdd ，在远程控制器上对单个命名空间进行 I/O），也可以作为控制器（支持多个命名空间，支持文件、字符设备或内存缓冲区作为后端）。内核数据通路反映了这种传输抽象，但为了性能采用了异步回调而不是阻塞方式。 nvmf(4) 是内核中的 Fabrics 主机。它创建 /dev/nvmeX 设备（以便 nvmecontrol(8) 工作），并通过 CAM 支持磁盘访问（ /dev/ndaX ）。未来的工作包括添加内核控制器，实现对 RDMA 和光纤通道的支持，以及为 TCP 队列对实现 TLS 保护。当前的代码可以在 https://github.com/bsdjhb/freebsd.git，分支 nvmf2 查看。这项工作由 Chelsio 赞助。

然后我参加了 Kristof Provost 关于 if_ovpn(4) 的讲座，并高兴地发现，即使 Wireguard 现在似乎很流行，仍然有一些人在努力改进 OpenVPN 的性能。 if_ovpn(4) 是一个干净的、内核中的 OpenVPN 客户端实现，仅支持部分功能：仅可用 AES-GCM 和 ChaCha 密码（其他是旧的），它不支持第 2 层网络（为了保持内核接口简单），只支持 UDP（TCP 需要更多工作）。用户空间处理控制信道，而内核处理数据信道。它们都共享一个套接字，在连接设置期间内核将其文件描述符传递给内核。内核传递给用户态未知的（即控制）数据包。用户空间通过 ioctl(2) 和 nvlist(9) 驱动内核进行扩展性操作（Linux 使用 netlink，该工作尚未集成到 FreeBSD）。密钥轮换是一个两阶段过程：新密钥被声明，稍后切换，而不会中断流量。vnet 对测试很有帮助（见 /usr/tests/sys/net/if_ovpn ）。 Netgate 4100 上测试了 if_ovpn(4) 的数据通道卸载（DCO）性能。带有 QAT（英特尔 QuickAssist 技术）卸载的 DCO 可达 1Gbit/s，带有 AES-NI 加密的 DCO 约为 750Mbit/s，带有软件加密的 DCO 约为 210Mbit/s，与使用 AES-NI 进行加密的 OpenVPN 在 if_tun 上的 210Mbit/s 进行比较。开发由 Netgate 赞助。

午饭休息时，由于天气原因，我们聚集在户外的一种类似露台的地方，拍摄了一张全家福照片，这是一个很好的聊天借口以及一件出人意料的吸引物：由 EuroBSDCon 基金会的 Katie McMillan 穿着的一件独特的 T 恤，仿制了 AC/DC 一张著名专辑的封面，上面写着“UNIX，通往Shell的高速公路”。接着在大学餐厅继续聊天和技术讨论。

下午的会议对我来说是由 Hiroki Sato 关于 USB DbC（调试功能）的讲话开始的。串行控制台使得调试固件或早期引导成为可能，但在现代硬件上没有串行ports，只有遗留接口，例如服务器机器上的 BMC（主板管理控制器）。 USB 替代了所有这些遗留接口。然而，它不允许直接连接两个主机，需要分层星形拓扑结构。因此，USB 调试是通过将一个主机的一个port更改为调试（“目标主机”），使其成为由调试主机管理的 USB 设备来实现的。可比较的调试技术包括 IEEE 1394（FireWire;遗留），它支持点对点和物理访问内存（请参见 dcons(4) ），但也包括 USB 2.0（请参见 EHCI 规范），尽管它需要特殊的中继器硬件。在调试主机上，普通的 USB 3 堆栈就足够了。在目标主机上，新的 udbc(4) 实验驱动程序管理port转变为用于简单串行通信的设备。它不需要完整的 USB 堆栈，因为它只需要管理两个 USB 管道的 TRB（传输请求块）环形缓冲区，而 DbC 设计为更复杂调试协议（例如 JTAG 和 Intel DCI）的简单传输。物理上，需要一个 A 到 A 的 USB 3.0 交叉线缆，并且，在所有ports的根集线器中，只有一个会转换为作为 USB 设备对调试主机进行操作。可以在 https://people.allbsd.org/~hrs/FreeBSD/udbc/20230915 找到代码和安装镜像。在收到足够的兼容反馈后，将提交补丁。这项工作与 x86 无关，而且移植到其他 BSD 应该很容易。 udbc(4) 可以扩展以模仿其他类型的 USB 设备（例如，可能是大容量存储设备）。

接下来，我参加了 Warner Losh 关于使用 LinuxBoot 启动 FreeBSD 的讲座，使用 loader.kboot 。这里不详细展开，因为演示内容很丰富，你可以在公开的幻灯片中找到所有细节。LinuxBoot 于 2017 年由 Google（作为 NERF）启动，旨在提供统一的引导环境，并摆脱 UEFI（大部分）。低级引导加载程序初始化机器，足以启动 Linux，然后运行脚本确定最终通过 kexec() 启动。这周围有一个非常好的社区。低级引导加载程序可以是 UEFI（预 EFI 接口）、coreboot romstage、U-boot SPL 或 Slim 引导加载程序。此讲座仅考虑 UEFI 及其 EDK2 实现，LinuxBoot 将其裁减为仅 PEI（预 EFI 接口；初始化机器的低级细节，如内存、时钟等）和运行时服务。通过使用 LinuxBoot，你只需为 Linux 编写设备驱动程序一次，而不是 UEFI DXE，带来多个优势：更快的上市时间，通常更快的引导时间，更安全的加固（与 Grub/EDK2 相比，100k 贡献者对 100 至 200）。FreeBSD 需要因几个原因移植到 LinuxBoot。在 amd64 和 aarch64 上，内核期望一些元数据（如内存映射）来引导，有些由系统固件（BIOS、UEFI）提供，而内核不能必然访问。这些数据通常由我们的 loader(8) 准备，因此第一步是将其作为 Linux 二进制文件port并添加“stand”设备以从中访问主机资源。此外，Linux 已通过 UEFI 的 SetVirtualAddressMapping() 设置虚拟地址映射，只能调用一次。这需要更改 FreeBSD 内核以支持复杂的虚拟到物理地址映射（在 aarch64 上还存在与 GICv3 中断控制器的问题）。通过这项工作，FreeBSD 是唯一一个在 x86 和 aarch64 上在 LinuxBoot 下完全不需要 Linux、不需要 GRUB 协助的 UEFI 操作系统。

我用 Toshaan Bharvani 关于在 OpenPOWER 上运行 FreeBSD 的讲话结束了第一天的讨论，这是一个令人兴奋的架构，可以让机器通过完全开放的固件启动。在 POWER 上的移植工作正朝着小端格式发展，因为很多桌面应用程序（比如 Firefox、JS）无法在大端格式的架构上正常运行。开放的固件包括由 skiboot 实现的 OPAL（Open Power Abstraction Loader），它启动运行 petitboot 引导加载程序的 Linux，同时还有一些开放的 BMC 实现，比如 LibreBMC 或 OpenBMC。目前的开发人员包括 Alfredo Dal’Ava Junior、Leandro Lupori、Andre Fernando da Silva 等。还有很多工作要做，请志愿者加入！目前的硬件仍然很昂贵，IBM AC922 开发者机器或 Talos II 入门级开发系统约为 5000 欧元。"软件"硬件，如基于 FPGA 的 Microwatt 和 LibreSOC，也可用。OpenPOWER HUB 计划(https://openpowerfoundation.org/hub) 提供对几种类型的 OpenPOWER 硬件的访问。下一代硬件预计价格会更合理，首先是入门级 PowerISA 3.1 机架(2024 年初)，然后是工作站（预计价格在 1000 至 1500 美元左右），以及单板计算机，如 PowerPi！在几个版本和世代中推出的嵌入式单板电脑，开发者的启用平台（可能在 500 美元左右），微控制器系统和基于 FPGA 的设备。因此，请帮助支持 BSD！

白天结束了一个美丽的社交活动。它发生在历史中心不远的地方，蒙德戈河的另一侧，在一个有着巨大房间以容纳我们所有人的餐馆里。我不记得是怎么发生的，但很快我发现自己坐在约翰·鲍德温和马克·约翰斯顿之间的一张桌子旁。当这两位巨匠进行技术交流时，总是令人愉悦地聆听。我们享受了这个晚上，围绕着一顿丰盛的自助餐有许多非正式聊天的机会。最壮观的时刻是由一群穿着传统背学术服装的男士们演绎的难忘的“科英布拉情歌”。他们表演中传达的情感力量简直无法用文字描述。

会议的第二天也是最后一天对我来说以埃里克·厄尔维谈论在 Modirum 使用 FreeBSD 开场，他们如何使用它（和其他开源软件），以及什么使社区对他们如此好。涉及jails、在 ZFS 上的 MySQL、  SO_REUSEPORT_LB 、epairs 和 relayd 的多样化战斗故事引人入胜，埃里克使这段旅程非常生动。他的幻灯片可以在会议网站上找到。

我对 Christos Margiolis 关于使用 DTrace 进行任意指令跟踪的工作非常感兴趣。DTrace 是一个强大的实时调试工具，我仍然没有充分利用，而 Christos 已经使用一个名为 kinst（“内核指令”）的新提供者增强了它。基本的 FDT 提供者（函数边界跟踪）只能跟踪未内联的内核函数的进入和返回点。kinst 提供探针以跟踪函数中的所有指令、特定指令或内联函数的进入或返回点。所选的探针信息从 dtrace(1) 传递到 libdtrace ，然后通过/ dev/dtrace/kinst 传递给 kinst。然后，kinst 对函数进行反汇编，并通过用断点指令覆盖目标指令来创建所请求的探针。在执行时，断点处理程序调用 dtrace_invop() ， dtrace_invop() 调用 kinst_invop() 。尽管被断点取代的指令仍然必须执行以保持执行正确。由于模拟是繁琐且容易出错的，这些指令被复制到一个跳板中，执行被手动转移至那里。这种方法的主要困难是 RIP/PC 相关指令仍然必须重新编码（amd64）或模拟（arm64、riscv）。内联函数跟踪的大部分繁重工作由 libtrace 完成（使用 ELF 和 DWARF 信息）。如果一个探针指定了一个未内联的函数，kinst 将其推迟到 FBT 以避免代码重复。每个内核模块都必须检查是否有内联函数，而这个过程目前非常缓慢。

下午会议开始时，我参加了 Kirk McKusick 的 gunion(8) 演讲。Kirk 有以清晰且教学性强的方式展示想法的天赋，你可以在 YouTube 上观看他的演讲视频体验到这一点。在对 GEOM 框架进行简要复习后，他介绍了 gunion(8) 实用程序，该程序跟踪只读磁盘上的更改并将其写入可写磁盘。这类似于 unionfs(5) 处理文件和目录的方式，但是在块设备的块的较低级别上操作。上层磁盘（可写磁盘）的大小必须至少等于下层磁盘（只读磁盘）的大小。联合元数据仅在联合存在时存在（当前没有持久性）。 gunion(8) 提供 create 和 destroy 命令，还包括 revert （丢弃保存在上层磁盘中的更改）和 commit （将上层磁盘的更改写回下层磁盘）。 gunion(8) 的用途包括尝试修复具有破损文件系统的磁盘，而无需担心更多损坏或需先备份：如果修复失败，只需使用 revert ；否则，可以提交并继续使用原始磁盘。 gunion(8) 还可以用于实现简易的克隆。 gnop(8) 在实现 gunion(8) 期间对测试错误恢复、延迟和无序 I/O 处理至关重要。

在我这一天的最后一个讲座中，我一直呆在“Auditorio”里，就像整天以来一样，观看迈克尔·德克斯特关于“FreeBSD 设备”的演讲。他首先阐述了一个受维基百科启发的软件设备的定义：只有足够的操作系统（“JeOS”），可以在通用硬件上运行一个应用程序。演示的准则双重。首先，展示了自由 BSD 如何适合这项任务（集成 OpenZFS，jails，bhyve），并且相对于 illumos 或 Linux 有一些优势。“JeOS”可能会因为打包的基础而成为一个更切实可行的现实，但通过构建选项几乎可以排除所有东西，并生成一个可以在几秒钟内引导的工作操作系统，“OccamBSD”（参见 github.com/michaeldexter/occambsd）。然后，可以基于“OccamBSD”生成定制映像，并在裸金属上或在虚拟化程序下运行。其次，展示了 FreeBSD 14.0 引入的一些新功能，这是保持最新发展的一种方式。

我最初希望参加马特乌什·皮奥特洛夫斯基的 ZFS 目录扩展讲座，但改变计划与 FreeBSD 基金会的埃德·马斯特会面，讨论我的当前项目，并了解如何推动最新的提交。

那天晚上，因为我周一早上要离开，我打算出去，联系了马特乌什·皮奥特洛夫斯基询问他的计划。我被引荐去了一家小吃酒吧，在那里我会见了大卫·科特勒胡伯和一群其他友好的人，其中包括克里斯托斯·马乔利斯、卢卡·皮扎米利奥、莫哈迪德和彼得。我和彼得以及其他一些人在一个爱尔兰酒吧度过了晚上，直到我已经记不起来的一个时间。幸运的是，我的离开火车的时间不算太早...

这是忙碌而充实的四天，我在这期间见了许多人，听到了许多优秀的技术项目。我现在期待下一届 BSD 会议可能不会让你感到意外。如果你从未参加过并有机会的话，来体验一下吧，我想你不会后悔的！

OLIVIER CERTNER 在 2004 年偶然接触到 FreeBSD，当时他在 Linux 之外寻找一种更严肃的替代方案，因为一次灾难性的系统崩溃摧毁了他的主要 ext3 硬盘。自那以后，他一直在尽可能多的地方使用它，并在系统中私下维护了一些小改动约 15 年。最近，他开始与社区和开源开发互动，并且目前正在重构调度优先级（这在 2024 年的 AsiaBSDCon 上发布了一篇论文），他已经开始分析奇怪的 OOM 行为，并计划在不久的将来解决一些深层 VFS 问题，包括重新设计 unionfs。他的公开工作大部分时间都得到了 FreeBSD 基金会的赞助。
